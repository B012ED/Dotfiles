#!/bin/bash
# Skrip: yusawall (FINAL FULL SCRIPT)
# Fungsi: Mengganti Wallpaper Pywal, menyimpan jalur untuk persistensi, dan me-reload Waybar secara aman.
# STATUS: Siap untuk digunakan dengan Waybar dinamis.

# --- Variabel Konfigurasi ---
WALLPAPER_DIR="$HOME/.config/wallpapers"
MONITOR_NAME="HDMI-A-1" # ðŸš¨ PERIKSA: Sesuaikan dengan nama monitor di 'yusaauto.conf' dan 'hyprctl monitors'
LAST_WALLPAPER_FILE="$HOME/.cache/last_wallpaper.txt" # File cache untuk persistensi

# 1. Cek Argumen & Pywal
if [ -z "$1" ]; then
    echo "Penggunaan: yusawall <nama_gambar>"; 
    echo "Contoh: yusawall galaxy.jpg"
    exit 1
fi
if ! command -v wal &> /dev/null; then
    echo "Error: pywal ('wal') tidak ditemukan. Pastikan Anda sudah menginstalnya."; exit 1
fi

# 2. Cek Jalur Wallpaper
WALLPAPER_PATH="$WALLPAPER_DIR/$1" 
if [ ! -f "$WALLPAPER_PATH" ]; then
    echo "Error: File wallpaper tidak ditemukan di: $WALLPAPER_PATH"; exit 1
fi

# 3. Aplikasikan Pywal dan Simpan Jalur (Kunci Persistensi)
echo "Menerapkan Pywal pada $WALLPAPER_PATH..."
wal -i "$WALLPAPER_PATH"

# ðŸ”‘ BARIS PERSISTENSI: Simpan jalur absolut wallpaper ke file cache.
echo "$WALLPAPER_PATH" > "$LAST_WALLPAPER_FILE"
echo "Jalur wallpaper disimpan untuk persistensi."

# 4. PENGATURAN WALLPAPER DI HYPRLAND 
echo "Mengatur wallpaper di Hyprland..."

# Blok pengaman jika hyprpaper belum berjalan (biasanya sudah dijalankan oleh yusaauto.conf)
if ! pgrep -x hyprpaper > /dev/null; then
    echo "Hyprpaper daemon tidak berjalan, meluncurkan sebagai pengaman..."
    hyprctl dispatch exec hyprpaper &
    sleep 1.0 
fi

# Gunakan perintah IPC Hyprpaper
hyprctl hyprpaper preload "$WALLPAPER_PATH"
hyprctl hyprpaper wallpaper "$MONITOR_NAME,$WALLPAPER_PATH"

echo "Wallpaper di monitor $MONITOR_NAME telah diubah."

# 5. Muat Ulang Waybar (Metode Stabil)
echo "Memuat ulang Waybar untuk menerapkan skema warna baru..."

pkill waybar 2>/dev/null
sleep 1.5 # Jeda 1.5 detik untuk stabilitas Waybar 

# Luncurkan Waybar baru
waybar > /dev/null 2>&1 &

echo "Proses penggantian wallpaper selesai. Periksa Waybar Anda!"